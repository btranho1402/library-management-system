<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Library System - Books Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
  <link rel="stylesheet" href="style.css" />
  <style>
    .brand-logo { max-height: clamp(24px, 6vw, 44px); height: auto; width: auto; object-fit: contain; display: block; }
    .navbar-brand { min-width: 0; }
    .brand-text { white-space: nowrap; }
    .glass { backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); background: rgba(255,255,255,0.65); border-radius: 1rem; box-shadow: 0 8px 30px rgba(0,0,0,0.08); }
    
    /* Custom styles */
    .book-card {
      transition: transform 0.2s, box-shadow 0.2s;
      height: 100%;
    }
    .book-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }
    .status-available { color: #198754; } /* Green */
    .status-borrowed { color: #dc3545; } /* Red */
    .status-reserved { color: #ffc107; } /* Yellow */
    .action-btn {
      min-width: 80px;
    }
    .modal-glass {
      backdrop-filter: blur(16px);
      background: rgba(255,255,255,0.85);
    }
    .status-icon { /* For status icons */
        font-size: 0.9em;
    }
  </style>
</head>
<body>
  <!-- Top Navbar Layout -->
  <nav class="navbar navbar-expand-lg bg-dark navbar-dark">
    <div class="container-lg">
      <a href="#" class="navbar-brand d-flex align-items-center gap-2">
        <span class="brand-text fw-semibold">Library System</span>
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav"
              aria-controls="nav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse mt-3 mt-lg-0" id="nav">
        <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link" href="home.html">Home</a></li>
          <li class="nav-item"><a class="nav-link active" href="#" aria-current="page">Books Management</a></li>
          <li class="nav-item"><a class="nav-link" href="others.html">Others</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container-fluid mt-4 px-3 px-md-5">
    <!-- Header Section -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
      <div>
        <h1 class="h2 mb-2">Books Management</h1>
        <p class="text-muted mb-0">Manage library books, track availability, and handle borrowing records</p>
      </div>
      <button id="addBookBtn" class="btn btn-primary mt-3 mt-md-0" data-bs-toggle="modal" data-bs-target="#addBookModal">
        <i class="bi bi-plus-circle me-2"></i>Add New Book
      </button>
    </div>

    <!-- Search and Filter Section -->
    <div class="glass p-4 mb-4">
      <div class="row g-3">
        <div class="col-md-6">
          <div class="input-group">
            <span class="input-group-text bg-transparent border-end-0">
              <i class="bi bi-search"></i>
            </span>
            <input type="text" class="form-control border-start-0" id="searchInput" placeholder="Search by title or author...">
          </div>
        </div>
        <div class="col-md-3">
          <select class="form-select" id="categoryFilter" data-placeholder="All Categories">
            <option value="">All Categories</option>
            <!-- Options will be populated by JavaScript -->
          </select>
        </div>
        <div class="col-md-3">
          <select class="form-select" id="statusFilter" data-placeholder="All Status">
            <option value="">All Status</option>
            <option value="available">Available</option>
            <option value="borrowed">Borrowed</option>
            <option value="reserved">Reserved</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Alert Area for API Messages -->
    <div id="alertArea" class="mb-4"></div>

    <!-- Books Table Section -->
    <div class="glass p-4">
      <div class="table-responsive">
        <table class="table table-hover align-middle" id="booksTable">
          <thead>
            <tr>
              <th scope="col">#</th>
              <th scope="col">Title</th>
              <th scope="col">Author</th>
              <th scope="col">Category</th>
              <th scope="col">Status</th>
              <th scope="col">Actions</th>
            </tr>
          </thead>
          <tbody id="booksTableBody">
            <!-- Books will be dynamically loaded here -->
            <tr>
              <td colspan="6" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Loading books...</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <!-- Pagination -->
      <nav aria-label="Books pagination" class="mt-4">
        <ul class="pagination justify-content-center">
          <li class="page-item disabled">
            <a class="page-link" href="#" tabindex="-1">Previous</a>
          </li>
          <li class="page-item active"><a class="page-link" href="#">1</a></li>
          <li class="page-item"><a class="page-link" href="#">2</a></li>
          <li class="page-item"><a class="page-link" href="#">3</a></li>
          <li class="page-item">
            <a class="page-link" href="#">Next</a>
          </li>
        </ul>
      </nav>
    </div>
  </div>

  <!-- Add Book Modal -->
  <div class="modal fade" id="addBookModal" tabindex="-1" aria-labelledby="addBookModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content modal-glass">
        <div class="modal-header">
          <h5 class="modal-title" id="addBookModalLabel">Add New Book</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addBookForm">
            <div class="row g-3">
              <div class="col-md-6">
                <label for="bookTitle" class="form-label">Title *</label>
                <input type="text" class="form-control" id="bookTitle" required>
              </div>
              <div class="col-md-6">
                <label for="bookAuthor" class="form-label">Author *</label>
                <input type="text" class="form-control" id="bookAuthor" required>
              </div>
              <div class="col-md-6">
                <label for="bookCategory" class="form-label">Category *</label>
                <select class="form-select" id="bookCategory" required>
                  <option value="">Select category</option>
                  <!-- Options will be populated by JavaScript -->
                </select>
              </div>
              <div class="col-md-6">
                <label for="bookPrice" class="form-label">Price *</label>
                <input type="number" class="form-control" id="bookPrice" step="0.01" min="0" required>
              </div>
              <div class="col-md-6 d-flex flex-column">
                <label class="form-label">Sample Page</label>
                <div class="d-flex align-items-center">
                  <input type="file" id="bookSampleFile" accept=".pdf,.png,.jpg,.jpeg" hidden>
                  <label for="bookSampleFile" class="btn btn-outline-secondary" id="bookSampleLabel">
                    <i class="bi bi-upload me-1"></i>Upload Sample Page
                  </label>
                  <span class="ms-2 small text-muted" id="bookSampleFilename">No file chosen</span>
                </div>
              </div>
              <div class="col-12">
                <label for="bookDescription" class="form-label">Description</label>
                <textarea class="form-control" id="bookDescription" rows="3"></textarea>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveBookBtn">Save Book</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Book Modal -->
  <div class="modal fade" id="editBookModal" tabindex="-1" aria-labelledby="editBookModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content modal-glass">
        <div class="modal-header">
          <h5 class="modal-title" id="editBookModalLabel">Edit Book</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editBookForm">
            <!-- This will be populated dynamically by JavaScript -->
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="updateBookBtn">Update Book</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
          integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
          crossorigin="anonymous"></script>
  
  <script src="./api.js"></script>
  <script>

    const bookCategories = [
      { type_id: 1, type_name: "Fiction" },
      { type_id: 2, type_name: "Non-Fiction" },
      { type_id: 3, type_name: "Science" },
      { type_id: 4, type_name: "Technology" },
      { type_id: 5, type_name: "History" },
      { type_id: 6, type_name: "Biography" }
    ];

    let books = [];

    // DOM Elements
    const booksTableBody = document.getElementById('booksTableBody');
    const searchInput = document.getElementById('searchInput');
    const categoryFilter = document.getElementById('categoryFilter');
    const statusFilter = document.getElementById('statusFilter');
    const addBookForm = document.getElementById('addBookForm');
    const saveBookBtn = document.getElementById('saveBookBtn');
    const bookSampleFile = document.getElementById('bookSampleFile');
    const bookSampleFilename = document.getElementById('bookSampleFilename');
    const editBookModalElement = document.getElementById('editBookModal'); // Get modal element
    const editBookModal = new bootstrap.Modal(editBookModalElement); // Initialize modal
    const editBookForm = document.getElementById('editBookForm');
    const updateBookBtn = document.getElementById('updateBookBtn');

    // State Variables
    let currentEditBookId = null;

    // Initialization
    document.addEventListener('DOMContentLoaded', async function() {
      // Check if user is logged in and admin status
      const currentUserStr = localStorage.getItem("currentUser");
      if (!currentUserStr) {
        window.location.href = "login.html";
        return;
      }

      const currentUser = JSON.parse(currentUserStr);
      const addBookBtn = document.getElementById("addBookBtn");
      
      // Hide "Add New Book" button for non-admin users
      if (Number(currentUser.is_admin) !== 1) {
        if (addBookBtn) {
          addBookBtn.style.display = 'none';
        }
      }

      populateCategorySelects(); // Populate dropdowns with categories
      await loadBooksFromAPI();  // Load books from API
      setupEventListeners();     // Set up event listeners for interactions
    });

    // API Integration
    async function loadBooksFromAPI() {
      try {
        const response = await apiGet("/books");
        if (response.success && response.data) {
          books = response.data;
          renderBooksTable();
        } else {
          showAlert("Failed to load books", "danger");
          renderBooksTable([]);
        }
      } catch (error) {
        showAlert(`Error loading books: ${error.message}`, "danger");
        renderBooksTable([]);
      }
    }

    // Show alert message
    function showAlert(message, type = "danger") {
      const alertArea = document.getElementById('alertArea');
      alertArea.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${escapeHTML(message)}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      `;
    }

    // Handle borrow action
    async function handleBorrow(bookId) {
      const currentUserStr = localStorage.getItem("currentUser");
      if (!currentUserStr) {
        showAlert("Please login first", "warning");
        setTimeout(() => {
          window.location.href = "login.html";
        }, 1500);
        return;
      }

      try {
        const currentUser = JSON.parse(currentUserStr);
        await apiPost("/borrow", {
          user_id: currentUser.user_id,
          book_id: bookId
        });
        showAlert("Book borrowed successfully!", "success");
        await loadBooksFromAPI();
      } catch (error) {
        const statusMatch = error.message.match(/HTTP (\d+)/);
        const status = statusMatch ? parseInt(statusMatch[1]) : 0;
        if (status === 409 || status === 404) {
          showAlert(error.message.replace(/^HTTP \d+: /, ""), "danger");
        } else {
          showAlert(`Error borrowing book: ${error.message}`, "danger");
        }
      }
    }

    // Handle return action
    async function handleReturn(bookId) {
      const currentUserStr = localStorage.getItem("currentUser");
      if (!currentUserStr) {
        showAlert("Please login first", "warning");
        setTimeout(() => {
          window.location.href = "login.html";
        }, 1500);
        return;
      }

      try {
        const currentUser = JSON.parse(currentUserStr);
        await apiPost("/return", {
          user_id: currentUser.user_id,
          book_id: bookId
        });
        showAlert("Book returned successfully!", "success");
        await loadBooksFromAPI();
      } catch (error) {
        const statusMatch = error.message.match(/HTTP (\d+)/);
        const status = statusMatch ? parseInt(statusMatch[1]) : 0;
        if (status === 409 || status === 404) {
          showAlert(error.message.replace(/^HTTP \d+: /, ""), "danger");
        } else {
          showAlert(`Error returning book: ${error.message}`, "danger");
        }
      }
    }

    // Helper Functions

    // Populate category select elements with options from bookCategories
    function populateCategorySelects() {
      const categorySelects = document.querySelectorAll('#categoryFilter, #bookCategory, #editCategory');
      categorySelects.forEach(select => {
        // Clear existing options except the placeholder
        select.innerHTML = ''; 
        const defaultOption = document.createElement('option');
        defaultOption.value = "";
        defaultOption.textContent = select.dataset.placeholder || 'Select category';
        select.appendChild(defaultOption);
        
        // Add category options from the mock data
        bookCategories.forEach(cat => {
          const option = document.createElement('option');
          option.value = cat.type_id; // Use type_id as value
          option.textContent = cat.type_name;
          select.appendChild(option);
        });
      });
    }

    // Get category name from type_id
    function getCategoryName(typeId) {
      if (!typeId) return 'N/A';
      const category = bookCategories.find(cat => cat.type_id === typeId);
      return category ? category.type_name : typeId; // Return type_id if name not found
    }

    // Get Bootstrap icon class for status
    function getStatusIcon(status) {
      const icons = {
        'available': 'bi-check-circle-fill',
        'borrowed': 'bi-x-circle-fill',
        'reserved': 'bi-clock-fill' 
      };
      return icons[status] || 'bi-question-circle-fill';
    }

    // Determine the book's current status based on availability_status
    function getBookStatus(book) {
        return book.availability_status === 1 ? 'available' : 'borrowed';
    }

    // Render the books table with the provided array of books
    function renderBooksTable(booksToRender = books) {
      if (booksToRender.length === 0) {
        booksTableBody.innerHTML = `
          <tr>
            <td colspan="6" class="text-center py-5">
              <i class="bi bi-book display-4 text-muted mb-3"></i>
              <p class="h5 text-muted">No books found</p>
              <p class="text-muted">Try adjusting your search or filter</p>
            </td>
          </tr>
        `;
        return;
      }

      booksTableBody.innerHTML = booksToRender.map(book => {
        // Determine status based on availability_status
        const isAvailable = book.availability_status === 1;
        const statusText = isAvailable ? 'Available' : 'Borrowed';
        const statusClass = isAvailable ? 'status-available' : 'status-borrowed';
        const statusIcon = isAvailable ? 'bi-check-circle-fill' : 'bi-x-circle-fill';
        
        // Get category/type name if available - prioritize name fields, then convert type_id to name
        const categoryName = book.category || book.type || book.type_name || getCategoryName(book.type_id);
        
        // Get price if available (show in title area or as additional info)
        const priceDisplay = book.price !== undefined ? `<small class="text-muted d-block">Price: $${parseFloat(book.price).toFixed(2)}</small>` : '';
        
        return `
        <tr>
          <th scope="row">${book.book_id || book.id || ''}</th>
          <td>
            <div class="fw-semibold">${escapeHTML(book.title || '')}</div>
            ${priceDisplay}
          </td>
          <td>${escapeHTML(book.author || '')}</td>
          <td>
            <span class="badge bg-light text-dark">${escapeHTML(categoryName)}</span>
          </td>
          <td>
            <span class="${statusClass} fw-semibold">
              <i class="bi ${statusIcon} status-icon me-1"></i>
              ${statusText}
            </span>
          </td>
          <td>
            <div class="d-flex gap-2">
              ${isAvailable ? 
                `<button class="btn btn-sm btn-success action-btn" onclick="handleBorrow(${book.book_id || book.id})">
                  <i class="bi bi-book-plus me-1"></i>Borrow
                </button>` :
                `<button class="btn btn-sm btn-warning action-btn" onclick="handleReturn(${book.book_id || book.id})">
                  <i class="bi bi-book-check me-1"></i>Return
                </button>`
              }
            </div>
          </td>
        </tr>
      `;
      }).join('');
    }

    // Filter books based on search input and selected filters
    function filterBooks() {
      const searchTerm = searchInput.value.toLowerCase();
      const categoryId = parseInt(categoryFilter.value); // Get category type_id
      const status = statusFilter.value;

      const filtered = books.filter(book => {
        // Search filter
        const matchesSearch = !searchTerm || 
          book.title.toLowerCase().includes(searchTerm) ||
          book.author.toLowerCase().includes(searchTerm);
        
        // Category filter (matches type_id)
        const matchesCategory = !categoryId || book.type_id === categoryId;
        
        // Status filter (derived from availability_status)
        const currentStatus = getBookStatus(book);
        const matchesStatus = !status || currentStatus === status;
        
        return matchesSearch && matchesCategory && matchesStatus;
      });

      renderBooksTable(filtered); // Re-render table with filtered results
    }

    // CRUD Operations

    // Add a new book
    function addBook(bookData) {
      // This function is no longer used - addBookAPI is used instead
      console.warn("addBook is deprecated - use addBookAPI instead");
    }

    // Edit book: Populate the edit modal with book data
    function editBook(bookId) {
      const book = books.find(b => b.book_id === bookId);
      if (!book) return;
      
      currentEditBookId = bookId; // Store the ID of the book being edited
      
      // Dynamically populate the edit form within the modal
      editBookForm.innerHTML = `
        <div class="row g-3">
          <div class="col-md-6">
            <label for="editTitle" class="form-label">Title *</label>
            <input type="text" class="form-control" id="editTitle" value="${escapeHTML(book.title)}" required>
          </div>
          <div class="col-md-6">
            <label for="editAuthor" class="form-label">Author *</label>
            <input type="text" class="form-control" id="editAuthor" value="${escapeHTML(book.author)}" required>
          </div>
          <div class="col-md-6">
            <label for="editCategory" class="form-label">Category *</label>
            <select class="form-select" id="editCategory" required>
              <option value="">Select category</option>
              ${bookCategories.map(cat => `
                <option value="${cat.type_id}" ${book.type_id === cat.type_id ? 'selected' : ''}>
                  ${escapeHTML(cat.type_name)}
                </option>
              `).join('')}
            </select>
          </div>
          <div class="col-12">
            <label for="editDescription" class="form-label">Description</label>
            <textarea class="form-control" id="editDescription" rows="3">${escapeHTML(book.description || '')}</textarea>
          </div>
        </div>
      `;
      
      editBookModal.show(); // Show the modal
    }

    // Update an existing book
    function updateBook() {
      // Find the index of the book being edited
      const bookIndex = books.findIndex(b => b.book_id === currentEditBookId);
      if (bookIndex === -1) {
          console.error("Error: Book to update not found.");
          editBookModal.hide();
          return;
      }
      
      // Get updated values from the edit form
      const updatedTitle = document.getElementById('editTitle').value.trim();
      const updatedAuthor = document.getElementById('editAuthor').value.trim();
      const updatedCategoryId = parseInt(document.getElementById('editCategory').value);
      const updatedDescription = document.getElementById('editDescription').value.trim();

      // Basic frontend validation
      if (!updatedTitle || !updatedAuthor || !updatedCategoryId) {
          alert("Please fill in all required fields correctly (Title, Author, Category).");
          return;
      }

      const originalBook = books[bookIndex];
      
      const updatedBook = {
        ...originalBook, // Preserve existing properties like book_id
        title: updatedTitle,
        author: updatedAuthor,
        type_id: updatedCategoryId,
        description: updatedDescription,
      };

      books[bookIndex] = updatedBook; // Update the book in our mock data array
      renderBooksTable(); // Re-render the table to show changes
      editBookModal.hide(); // Hide the edit modal
      
      alert('Book updated successfully!'); // User feedback
    }

    // Delete a book
    function deleteBook(bookId) {
      // Confirm before deleting
      if (confirm('Are you sure you want to delete this book? This action cannot be undone.')) {
        // Filter out the book to be deleted from the array
        books = books.filter(book => book.book_id !== bookId);
        renderBooksTable(); // Re-render the table
        alert('Book deleted successfully!'); // User feedback
      }
    }

    // Event Listeners Setup
    function setupEventListeners() {
      // Live filtering as user types or changes selections
      searchInput.addEventListener('input', filterBooks);
      categoryFilter.addEventListener('change', filterBooks);
      statusFilter.addEventListener('change', filterBooks);
      // File input change listener to show selected filename
      if (bookSampleFile && bookSampleFilename) {
        bookSampleFile.addEventListener('change', function() {
          const f = bookSampleFile.files[0];
          bookSampleFilename.textContent = f ? f.name : 'No file chosen';
        });
      }

      // Event listener for the "Save Book" button in the add modal
      saveBookBtn.addEventListener('click', async function() {
        if (!addBookForm.checkValidity()) {
          addBookForm.reportValidity();
          return;
        }

        // Check if user is logged in and is admin
        const currentUserStr = localStorage.getItem("currentUser");
        if (!currentUserStr) {
          alert("Please login first");
          window.location.href = "login.html";
          return;
        }

        const currentUser = JSON.parse(currentUserStr);
        if (Number(currentUser.is_admin) !== 1) {
          alert("Admins only");
          return;
        }
        
        // Read form fields
        const title = document.getElementById('bookTitle').value.trim();
        const author = document.getElementById('bookAuthor').value.trim();
        const description = document.getElementById('bookDescription').value.trim();
        const price = parseFloat(document.getElementById('bookPrice').value);
        const type_id = parseInt(document.getElementById('bookCategory').value);

        // Build payload
        const payload = {
          user_id: currentUser.user_id,
          title,
          author,
          description,
          price,
          type_id
        };

        try {
          // Call backend API
          await addBookAPI(payload);
          
          const modal = bootstrap.Modal.getInstance(document.getElementById('addBookModal'));
          modal.hide();
          addBookForm.reset();
          addBookForm.querySelector('#bookCategory').value = "";
          // Clear file input and filename display
          if (bookSampleFile) {
            bookSampleFile.value = "";
          }
          if (bookSampleFilename) {
            bookSampleFilename.textContent = 'No file chosen';
          }
          showAlert("Book added successfully!", "success");
          await loadBooksFromAPI();
        } catch (error) {
          // On failure: alert the returned message
          const errorMessage = error.message.replace(/^HTTP \d+: /, "");
          alert(errorMessage);
        }
      });
      
      // Event listener for the "Update Book" button in the edit modal
      updateBookBtn.addEventListener('click', updateBook);
    }

    // Utility for HTML escaping
    function escapeHTML(str) {
        if (typeof str !== 'string') return str; // Return non-strings as is
        const div = document.createElement('div');
        div.appendChild(document.createTextNode(str));
        return div.innerHTML;
    }

    // Expose functions to be called by inline HTML onclick attributes
    window.editBook = editBook;
    window.deleteBook = deleteBook;
    window.handleBorrow = handleBorrow;
    window.handleReturn = handleReturn;

  </script>
</body>
</html>